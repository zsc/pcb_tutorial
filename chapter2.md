# 第2章：布局算法与优化策略

## 学习目标

本章将从算法和优化理论的角度深入剖析PCB布局问题。我们将把元器件布局视为一个多目标、多约束的组合优化问题，运用图论、启发式算法和约束编程等方法构建系统化的解决方案。通过本章学习，你将掌握：

1. 将PCB布局问题抽象为数学模型的方法
2. 主流布局算法的原理、实现和性能分析
3. 热管理和时序优化在布局中的量化方法
4. 自动化布局工具的核心算法和优化策略
5. 实际工程中的布局权衡和决策框架

## 2.1 元器件布局的图论模型

### 2.1.1 问题定义与数学抽象

PCB布局本质上是一个在二维平面上放置矩形元器件并优化其连接的问题。从图论角度，我们可以将其建模为：

**定义2.1（布局问题的图表示）**：
给定一个超图 $H = (V, E)$，其中：
- $V = \{v_1, v_2, ..., v_n\}$ 表示元器件集合
- $E = \{e_1, e_2, ..., e_m\}$ 表示网络（net）集合，每个 $e_i \subseteq V$ 连接多个元器件

目标是找到一个映射 $f: V \rightarrow \mathbb{R}^2$，将每个元器件映射到二维平面的位置 $(x_i, y_i)$，使得：

$$\min \sum_{e \in E} \text{HPWL}(e) + \alpha \cdot \text{Overlap}(V) + \beta \cdot \text{Congestion}(E)$$

其中：
- HPWL (Half-Perimeter Wire Length) 是半周长线长估计
- Overlap 是元器件重叠惩罚
- Congestion 是布线拥塞度估计

### 2.1.2 连通性矩阵与拉普拉斯矩阵

元器件之间的连接关系可以用连通性矩阵 $C$ 表示：

$$C_{ij} = \begin{cases}
w_{ij} & \text{如果 } v_i \text{ 和 } v_j \text{ 有连接} \\
0 & \text{否则}
\end{cases}$$

其中 $w_{ij}$ 是连接权重，通常与网络的关键程度成正比。对应的拉普拉斯矩阵 $L = D - C$，其中 $D$ 是度矩阵。

**定理2.1（谱布局定理）**：
拉普拉斯矩阵的第二小特征值（Fiedler值）及其对应的特征向量（Fiedler向量）提供了一维布局的最优解。

证明略。这个结果可以推广到二维，使用第二和第三小特征向量作为初始布局的 x 和 y 坐标。

### 2.1.3 多层次图分割

对于大规模电路，直接求解是不现实的。多层次方法通过递归粗化和细化来解决：

```
算法 2.1: 多层次布局框架
输入: 超图 H = (V, E)
输出: 布局坐标 {(x_i, y_i)}

1. 粗化阶段：
   H_0 = H
   for k = 0 to l-1:
      H_{k+1} = Coarsen(H_k)  // 合并相似节点
   
2. 初始布局：
   Layout(H_l)  // 在最粗层求解
   
3. 细化阶段：
   for k = l-1 downto 0:
      Project(H_{k+1} → H_k)  // 投影到细层
      Refine(H_k)  // 局部优化
```

### 2.1.4 最小割与平衡分割

布局问题经常需要将电路分割成多个子模块。最小割问题可以形式化为：

**定义2.2（k-way平衡分割）**：
将顶点集 $V$ 分割为 $k$ 个不相交子集 $V_1, V_2, ..., V_k$，使得：
1. $\bigcup_{i=1}^k V_i = V$ 且 $V_i \cap V_j = \emptyset$ （完全分割）
2. $|V_i| \leq (1+\epsilon) \cdot |V|/k$ （平衡约束）
3. 最小化割边数：$\min \sum_{i<j} |E(V_i, V_j)|$

这是一个NP困难问题，实践中常用的近似算法包括：
- **Kernighan-Lin算法**：时间复杂度 $O(n^2 \log n)$
- **Fiduccia-Mattheyses算法**：线性时间复杂度 $O(|E|)$
- **谱分割方法**：基于Fiedler向量的分割

### 2.1.5 Steiner树与全局布线估计

对于多端网络，我们需要估计其布线长度。Steiner最小树问题：

$$\text{SMT}(N) = \min_{S \subseteq \mathbb{R}^2} \sum_{e \in T} |e|$$

其中 $T$ 是连接网络 $N$ 中所有端点的树，$S$ 是Steiner点集合。

**定理2.2（RSMT近似）**：
对于曼哈顿距离，直角Steiner最小树（RSMT）的长度满足：
$$\text{RSMT}(N) \leq \text{MST}(N) \leq \frac{3}{2} \cdot \text{RSMT}(N)$$

实际中常用HPWL（半周长）作为快速估计：
$$\text{HPWL}(N) = (x_{\max} - x_{\min}) + (y_{\max} - y_{\min})$$

## 2.2 力导向算法与模拟退火

### 2.2.1 力导向布局的物理模型

力导向算法将布局问题类比为物理系统，元器件之间的连接视为弹簧，目标是找到系统的能量最小状态。

**能量函数定义**：
$$E = \sum_{(i,j) \in E} k_{ij} \cdot d_{ij}^2 + \sum_{i \neq j} \frac{q_i \cdot q_j}{d_{ij}}$$

其中：
- 第一项是吸引力（弹簧势能），$k_{ij}$ 是弹簧系数
- 第二项是排斥力（库仑力），$q_i$ 是"电荷"
- $d_{ij} = \|(x_i, y_i) - (x_j, y_j)\|$ 是欧氏距离

对每个元器件，合力为：
$$\vec{F}_i = -\nabla_i E = \sum_{j \in N(i)} k_{ij}(d_{ij} - l_{ij})\frac{\vec{r}_{ij}}{d_{ij}} - \sum_{j \neq i} \frac{q_i q_j}{d_{ij}^3}\vec{r}_{ij}$$

### 2.2.2 快速多极子方法（FMM）

直接计算所有对之间的排斥力需要 $O(n^2)$ 时间。快速多极子方法可以将复杂度降到 $O(n \log n)$：

1. **多极展开**：远场力用多极展开近似
   $$\Phi(r) = \sum_{k=0}^p \frac{M_k}{r^{k+1}}P_k(\cos\theta)$$
   
2. **层次分解**：使用四叉树（2D）或八叉树（3D）划分空间
3. **局部展开**：将远场多极展开转换为局部展开

### 2.2.3 模拟退火算法

模拟退火是一种通用的随机优化算法，特别适合处理布局这类组合优化问题。

```
算法 2.2: 模拟退火布局
输入: 初始布局 S_0, 初始温度 T_0, 冷却率 α
输出: 优化后的布局 S_best

S = S_0, S_best = S_0
T = T_0
while T > T_min:
    for i = 1 to moves_per_temp:
        S' = Perturb(S)  // 随机移动、交换或旋转
        ΔC = Cost(S') - Cost(S)
        if ΔC < 0 or Random() < exp(-ΔC/T):
            S = S'
            if Cost(S) < Cost(S_best):
                S_best = S
    T = α · T  // 降温
return S_best
```

**关键参数选择**：
- 初始温度：$T_0 = -\Delta C_{\text{avg}} / \ln(p_0)$，其中 $p_0 \approx 0.9$
- 冷却率：$\alpha \in [0.85, 0.95]$
- 移动策略：
  - 单元移动：将元器件移到新位置
  - 单元交换：交换两个元器件位置
  - 方向旋转：旋转元器件90°

### 2.2.4 自适应退火策略

标准模拟退火收敛慢，自适应策略可以加速：

**温度自适应**：
$$T_{k+1} = T_k \cdot \frac{1 + \ln(1 + \delta)}{1 + \delta}$$
其中 $\delta = \frac{\sigma(C_k)}{\bar{C}_k}$ 是成本标准差与均值之比。

**范围限制**：随温度降低逐渐缩小移动范围
$$R(T) = R_{\max} \cdot \left(\frac{T}{T_0}\right)^\beta$$

## 2.3 约束满足问题(CSP)在布局中的应用

### 2.3.1 布局的CSP建模

PCB布局可以建模为约束满足问题：

**定义2.3（布局CSP）**：
- 变量：$X = \{x_1, y_1, o_1, ..., x_n, y_n, o_n\}$，位置和方向
- 域：$D_i = [0, W] \times [0, H] \times \{0°, 90°, 180°, 270°\}$
- 约束：
  1. 非重叠约束：$\forall i \neq j: \text{NoOverlap}(R_i, R_j)$
  2. 边界约束：$\forall i: R_i \subseteq [0,W] \times [0,H]$
  3. 对齐约束：特定元器件需要对齐
  4. 间距约束：$\text{dist}(R_i, R_j) \geq d_{ij}$
  5. 区域约束：某些元器件必须在特定区域

### 2.3.2 约束传播与弧一致性

约束传播通过迭代缩减变量域来加速求解：

**算法2.3：AC-3弧一致性算法**
```
function AC3(csp):
    queue = 所有约束弧 (Xi, Xj)
    while queue不空:
        (Xi, Xj) = queue.pop()
        if Revise(Xi, Xj):
            if Domain(Xi) = ∅:
                return False  // 无解
            for Xk in Neighbors(Xi) - {Xj}:
                queue.add((Xk, Xi))
    return True

function Revise(Xi, Xj):
    revised = False
    for x in Domain(Xi):
        if 不存在y ∈ Domain(Xj)使得(x,y)满足约束:
            Domain(Xi).remove(x)
            revised = True
    return revised
```

### 2.3.3 序列对表示法

序列对（Sequence Pair）是一种紧凑的布局表示方法：

给定两个序列 $(S^+, S^-)$，元器件的相对位置关系：
- 若 $i$ 在 $S^+$ 和 $S^-$ 中都在 $j$ 之前：$i$ 在 $j$ 左边
- 若 $i$ 在 $S^+$ 中在 $j$ 之前，但在 $S^-$ 中在 $j$ 之后：$i$ 在 $j$ 下边

**定理2.3**：任何可行布局都对应唯一的序列对，反之亦然。

从序列对计算坐标使用最长路径算法：
1. 构建水平约束图 $G_h$ 和垂直约束图 $G_v$
2. 在 DAG 上求最长路径得到坐标

### 2.3.4 整数线性规划(ILP)方法

布局问题可以形式化为混合整数线性规划：

**决策变量**：
- $x_i, y_i$：元器件 $i$ 的左下角坐标
- $z_{ij}^h, z_{ij}^v$：二进制变量，表示相对位置

**目标函数**：
$$\min \sum_{net \in N} \text{HPWL}(net) + \lambda \cdot \text{Area}$$

**约束条件**：
```
非重叠约束（使用大M方法）：
x_i + w_i ≤ x_j + M(1 - z_{ij}^h)
x_j + w_j ≤ x_i + M·z_{ij}^h
y_i + h_i ≤ y_j + M(1 - z_{ij}^v)
y_j + h_j ≤ y_i + M·z_{ij}^v
z_{ij}^h + (1-z_{ij}^h) + z_{ij}^v + (1-z_{ij}^v) ≥ 1
```

## 2.4 热点分析与功率密度优化

### 2.4.1 热模型与功率密度

PCB上的热分布遵循热传导方程：

$$\rho c_p \frac{\partial T}{\partial t} = \nabla \cdot (k \nabla T) + Q$$

其中：
- $\rho$：材料密度
- $c_p$：比热容
- $k$：热导率
- $Q$：热源（功率密度）

稳态情况下，$\frac{\partial T}{\partial t} = 0$，得到泊松方程：
$$\nabla^2 T = -\frac{Q}{k}$$

### 2.4.2 热阻网络模型

将PCB离散化为网格，每个单元的热阻：

$$R_{th} = \frac{L}{k \cdot A}$$

其中 $L$ 是长度，$A$ 是横截面积。元器件到环境的总热阻：

$$T_j = T_a + P \cdot R_{ja}$$

其中：
- $T_j$：结温
- $T_a$：环境温度
- $P$：功耗
- $R_{ja}$：结到环境的热阻

### 2.4.3 功率密度约束的布局优化

**目标函数**：
$$\min f = \alpha \cdot \text{HPWL} + \beta \cdot T_{\max} + \gamma \cdot \sigma_T$$

其中 $\sigma_T$ 是温度分布的标准差，用于均衡热分布。

**热感知的力导向算法**：
在标准力导向算法基础上添加热排斥力：

$$\vec{F}_{thermal} = \sum_{j \in \text{HotSpots}} \frac{P_i \cdot P_j}{d_{ij}^2} \cdot \vec{r}_{ij}$$

### 2.4.4 多物理场耦合优化

考虑热-电-机械耦合：

1. **热膨胀应力**：
   $$\sigma = E \cdot \alpha \cdot \Delta T$$
   其中 $E$ 是杨氏模量，$\alpha$ 是热膨胀系数

2. **电阻温度系数**：
   $$R(T) = R_0[1 + \alpha(T - T_0)]$$

3. **功率-温度反馈**：
   $$P(T) = P_0 \cdot f(T)$$
   
迭代求解直到收敛：
```
repeat:
    1. 根据当前布局计算功率分布
    2. 求解热方程得到温度场
    3. 更新温度相关参数
    4. 优化布局降低热点
until 温度变化 < ε
```

### 2.4.5 热通孔优化配置

热通孔数量优化是一个权衡问题：

**有效热导率模型**：
$$k_{eff} = k_{PCB}(1-\phi) + k_{via} \cdot \phi$$

其中 $\phi = \frac{n \cdot A_{via}}{A_{total}}$ 是通孔面积比。

**优化问题**：
$$\min_{n,位置} \{T_{\max} - \lambda \cdot \text{RoutingArea}\}$$

约束：
- 最小间距：$d_{ij} \geq d_{\min}$
- 最大数量：$n \leq n_{\max}$

## 2.5 关键路径识别与时序优化

### 2.5.1 时序图模型

将电路的时序关系建模为有向无环图（DAG）：

**定义2.4（时序图）**：
$G_t = (V_t, E_t)$ 其中：
- 节点 $v \in V_t$ 表示寄存器或I/O端口
- 边 $(u,v) \in E_t$ 表示组合逻辑路径
- 边权重 $w(u,v) = t_{prop} + t_{trace}$

其中：
- $t_{prop}$：逻辑延迟
- $t_{trace}$：走线延迟 = $\frac{L}{v_p}$，$v_p = \frac{c}{\sqrt{\epsilon_{eff}}}$

### 2.5.2 静态时序分析（STA）

**到达时间（Arrival Time）**：
$$AT(v) = \max_{u \in pred(v)} \{AT(u) + d(u,v)\}$$

**要求时间（Required Time）**：
$$RT(v) = \min_{w \in succ(v)} \{RT(w) - d(v,w)\}$$

**时序裕量（Slack）**：
$$Slack(v) = RT(v) - AT(v)$$

关键路径是所有 $Slack = 0$ 的路径。

### 2.5.3 时序驱动的布局算法

**目标函数**：
$$\min f = \sum_{net} W(net) \cdot L(net)$$

其中权重 $W(net)$ 基于时序关键度：
$$W(net) = 1 + \alpha \cdot e^{-\beta \cdot Slack(net)}$$

**算法2.4：时序驱动的迭代优化**
```
1. 初始布局
2. repeat:
   a. 执行静态时序分析
   b. 识别关键路径
   c. 计算net权重
   d. 使用加权目标函数重新优化布局
   e. 更新延迟估计
   until 时序收敛或达到迭代上限
```

### 2.5.4 路径平衡与时钟偏斜优化

**时钟偏斜优化**：
给定时钟到各寄存器的延迟 $t_i$，优化问题：

$$\min \max_{i,j} |t_i - t_j|$$

约束：
$$t_i + T_{cq} + T_{logic}(i,j) + T_{setup} < T_{clk} + t_j$$

其中：
- $T_{cq}$：时钟到输出延迟
- $T_{logic}$：逻辑路径延迟
- $T_{setup}$：建立时间
- $T_{clk}$：时钟周期

### 2.5.5 延迟匹配与等长约束

对于差分对和并行总线，需要长度匹配：

**蛇形走线长度计算**：
```
给定：直线距离 D，目标长度 L
蛇形参数：
- 段数 n = ⌈(L-D)/(2h)⌉
- 段长 h = 可调参数
- 间距 s ≥ 3w (3倍线宽)
实际长度：L_actual = D + n·2h + n·s
```

**延迟匹配优化**：
$$\min \sum_{i \in Group} (L_i - L_{target})^2$$

约束：
- $|L_i - L_{target}| \leq \Delta L_{\max}$
- 相位匹配：$|\phi_i - \phi_{target}| \leq \Delta \phi_{\max}$

## 案例研究：Google TPU的模块化布局策略

### 背景
Google TPU v4采用了高度模块化的布局策略，单芯片集成了128×128的脉动阵列，功耗达到170W。其PCB设计面临的挑战包括：
- 超高带宽内存（HBM）接口布局
- 功率密度达到 100W/cm²的热管理
- 32Gbps SerDes信号的布局约束

### 布局策略分析

**1. 层次化分区**
TPU PCB采用了三级层次布局：
- L1：核心计算区域（脉动阵列）
- L2：内存控制器和HBM
- L3：I/O和电源管理

**2. 热驱动的元器件放置**
```
热源分离距离计算：
d_min = 2√(P₁·P₂·R_th/ΔT_max)
其中：
- P₁, P₂：两个热源功率
- R_th：热阻
- ΔT_max：允许温差

实测：VRM与TPU芯片距离 > 15mm
```

**3. 信号完整性优化**
- HBM到TPU走线长度：< 30mm
- 差分对内偏斜：< 5ps
- 层叠设计：28层HDI，盲埋孔技术

### 关键创新

1. **冷板集成设计**：PCB预留液冷管道安装孔位，热界面材料厚度优化到0.15mm
2. **动态功率分配**：根据工作负载实时调整不同模块的功率预算
3. **AI辅助布局**：使用强化学习优化关键信号路径，相比人工布局延迟降低12%

### 经验教训

- 早期热仿真至关重要：在概念设计阶段就需要CFD分析
- 模块化不等于性能妥协：合理的分区可以简化设计同时保持性能
- 电源完整性优先：TPU设计中PDN占用了40%的布线资源

## 高级话题：机器学习驱动的自动布局优化

### 深度强化学习方法

近年来，深度强化学习（DRL）在PCB自动布局中展现出巨大潜力。核心思想是将布局问题建模为马尔可夫决策过程（MDP）：

**状态空间** $S$：当前布局配置、剩余元器件、布线拥塞图
**动作空间** $A$：放置位置、旋转角度
**奖励函数** $R$：
$$R = -\alpha \cdot \text{HPWL} - \beta \cdot \text{Overlap} - \gamma \cdot \text{Congestion} + \delta \cdot \text{Progress}$$

**Policy网络架构**：
- 图神经网络（GNN）编码电路拓扑
- 卷积神经网络（CNN）处理布局图像
- Transformer处理序列决策

### 图神经网络的应用

将电路表示为异构图，使用消息传递更新节点特征：
$$h_i^{(k+1)} = \sigma\left(W_{self}h_i^{(k)} + \sum_{j \in N(i)} W_{edge}h_j^{(k)}\right)$$

优势：
- 自然处理不规则拓扑
- 置换不变性
- 可扩展到大规模电路

### 迁移学习策略

预训练模型在新设计上的快速适应：
1. 在大规模数据集上预训练
2. 针对特定设计约束微调
3. 持续学习避免灾难性遗忘

实验结果：相比从零开始训练，收敛速度提升5-10倍。

## 本章小结

本章深入探讨了PCB布局的算法基础和优化策略。我们从图论模型出发，系统介绍了各种布局算法的数学原理和实现方法。

**核心要点**：

1. **图论基础**：PCB布局本质是一个多目标优化问题，可用超图、连通性矩阵等数学工具建模
2. **经典算法**：力导向算法和模拟退火提供了通用的优化框架，各有优劣
3. **约束处理**：CSP方法和ILP为处理复杂约束提供了系统化方案
4. **多物理场耦合**：现代PCB设计必须同时考虑电、热、机械等多个物理场
5. **时序感知**：高速设计中时序约束往往是决定性因素
6. **AI赋能**：机器学习特别是深度强化学习正在革新传统EDA工具

**关键公式回顾**：
- HPWL线长估计：$\text{HPWL} = (x_{\max} - x_{\min}) + (y_{\max} - y_{\min})$
- 热传导方程：$\nabla^2 T = -\frac{Q}{k}$
- 时序裕量：$Slack = RT - AT$
- 模拟退火接受概率：$P = e^{-\Delta C/T}$

**实践建议**：
1. 先用快速算法获得初始解，再用精确算法局部优化
2. 多目标优化时合理设置权重系数
3. 充分利用问题的层次结构和稀疏性
4. 在设计早期就考虑热和时序约束

## 练习题

### 基础题

**练习2.1** 给定5个元器件的连接矩阵如下，计算对应的拉普拉斯矩阵，并求出Fiedler值和Fiedler向量。
```
C = [0 2 0 1 0]
    [2 0 3 0 1]
    [0 3 0 2 0]
    [1 0 2 0 1]
    [0 1 0 1 0]
```
*提示：拉普拉斯矩阵 L = D - C，其中D是度矩阵*

<details>
<summary>答案</summary>

度矩阵 D = diag(3, 6, 5, 4, 2)
拉普拉斯矩阵 L = D - C
Fiedler值（第二小特征值）≈ 0.438
Fiedler向量提供了一维布局的最优排序
</details>

**练习2.2** 使用HPWL估计以下布局的总线长：3个元器件分别位于(0,0)、(10,5)、(5,10)，它们形成一个三端网络。

*提示：HPWL = (x_max - x_min) + (y_max - y_min)*

<details>
<summary>答案</summary>

x_max = 10, x_min = 0
y_max = 10, y_min = 0
HPWL = (10-0) + (10-0) = 20
</details>

**练习2.3** 在模拟退火算法中，当前温度T=100，成本增加ΔC=50，计算接受该移动的概率。

*提示：P = exp(-ΔC/T)*

<details>
<summary>答案</summary>

P = exp(-50/100) = exp(-0.5) ≈ 0.606
即有60.6%的概率接受这个使成本增加的移动
</details>

**练习2.4** 两个10W的热源相距20mm，热阻为5K/W，允许温差为30K。验证这个距离是否满足热约束。

*提示：使用热源分离距离公式 d_min = 2√(P₁·P₂·R_th/ΔT_max)*

<details>
<summary>答案</summary>

d_min = 2√(10×10×5/30) = 2√(16.67) ≈ 8.16mm
实际距离20mm > 8.16mm，满足热约束
</details>

### 挑战题

**练习2.5** 设计一个算法，将n个不同尺寸的矩形元器件放置在W×H的PCB板上，最小化总HPWL同时保证无重叠。描述你的算法步骤和时间复杂度。

*提示：考虑使用序列对表示法或模拟退火*

<details>
<summary>答案</summary>

算法框架：
1. 初始化：随机生成序列对(S+, S-)
2. 迭代优化：
   - 扰动：交换序列中两个元素
   - 解码：从序列对计算坐标（O(n²)）
   - 评估：计算HPWL
   - 接受/拒绝：基于模拟退火准则
3. 降温并重复
时间复杂度：O(I·n²)，其中I是迭代次数
空间复杂度：O(n)存储序列
</details>

**练习2.6** 给定一个包含关键路径的时序图，路径上有5段，延迟分别为[2ns, 3ns, 1.5ns, 2.5ns, 1ns]。如果要求总延迟不超过9ns，如何通过调整布局优化最长的两段？

*提示：识别关键段并考虑走线长度与延迟的关系*

<details>
<summary>答案</summary>

当前总延迟 = 2+3+1.5+2.5+1 = 10ns
需要减少1ns
最长两段：3ns和2.5ns
优化策略：
1. 缩短这两段的物理距离
2. 假设延迟与距离成正比
3. 将3ns段缩短到2.4ns（减少20%距离）
4. 将2.5ns段缩短到2.1ns（减少16%距离）
最终：2+2.4+1.5+2.1+1 = 9ns
</details>

**练习2.7** （开放题）讨论在以下场景中应该选择哪种布局算法，并说明理由：
a) 1000个元器件的消费电子产品PCB
b) 50个元器件的高频RF电路板
c) 混合信号电路，包含模拟和数字部分

<details>
<summary>答案</summary>

a) 1000个元器件：多层次方法+模拟退火
   - 规模大，需要层次化处理
   - 消费电子对成本敏感，需要优化面积
   
b) 50个元器件RF电路：约束驱动的CSP方法
   - 元器件少但约束复杂
   - RF电路对布局极其敏感
   - 需要严格控制信号路径和隔离
   
c) 混合信号：分区+力导向算法
   - 先将模拟和数字分区
   - 各区内用力导向优化
   - 接口处特殊处理防止串扰
</details>

**练习2.8** 编写伪代码实现一个简化的AC-3算法，用于处理元器件间的最小间距约束。

<details>
<summary>答案</summary>

```
function SimplifiedAC3(components, min_spacing):
    queue = []
    for each pair (i,j) in components:
        queue.push((i,j))
        queue.push((j,i))
    
    while queue not empty:
        (Xi, Xj) = queue.pop()
        if ReviseSpacing(Xi, Xj, min_spacing):
            if Domain(Xi) is empty:
                return "No solution"
            for Xk in neighbors(Xi) except Xj:
                queue.push((Xk, Xi))
    return "Consistent"

function ReviseSpacing(Xi, Xj, min_spacing):
    revised = false
    for pos_i in Domain(Xi):
        valid = false
        for pos_j in Domain(Xj):
            if distance(pos_i, pos_j) >= min_spacing:
                valid = true
                break
        if not valid:
            Domain(Xi).remove(pos_i)
            revised = true
    return revised
```
</details>

## 常见陷阱与错误（Gotchas）

### 1. 局部最优陷阱
**问题**：贪心算法和简单梯度下降容易陷入局部最优
**症状**：布局看起来"还行"但远非最优，特别是线长明显过长
**解决方案**：
- 使用模拟退火的随机扰动机制
- 多次运行with不同初始解
- 采用多层次方法避免早期决策锁定

### 2. 约束冲突
**问题**：过度约束导致无解或求解时间爆炸
**症状**：CSP求解器返回"无解"或运行时间极长
**调试技巧**：
```
1. 逐个禁用约束，找出冲突源
2. 检查约束的数值是否合理（如最小间距）
3. 使用软约束替代硬约束
4. 可视化约束图找出过约束区域
```

### 3. 热点形成
**问题**：高功率元器件聚集造成局部过热
**症状**：仿真显示温度超过器件额定值
**预防措施**：
- 在布局早期就引入热约束
- 使用热感知的成本函数
- 预留散热器和热通孔位置

### 4. 时序收敛失败
**问题**：布局后时序无法满足要求
**症状**：STA报告negative slack
**常见原因**：
- 关键路径元器件相距太远
- 没有考虑实际走线的迂回
- 时钟树不平衡

### 5. 算法参数调优
**问题**：默认参数性能差
**关键参数及调优策略**：
- 模拟退火初始温度：太高收敛慢，太低陷入局部最优
- 权重系数：需要根据设计优先级调整
- 迭代次数：在质量和运行时间间权衡

## 最佳实践检查清单

### 布局前准备
- [ ] 完成原理图检查，确认网表正确
- [ ] 识别关键信号和高速信号
- [ ] 估算功率分布和热设计要求
- [ ] 明确机械约束（接插件、安装孔位置）
- [ ] 制定布局策略（模块划分、层次规划）

### 布局过程
- [ ] 优先放置固定位置元器件（接插件、晶振等）
- [ ] 按功能模块分组放置
- [ ] 保持高速信号路径最短
- [ ] 模拟和数字电路适当隔离
- [ ] 去耦电容靠近电源引脚
- [ ] 预留测试点和调试接口

### 热设计检查
- [ ] 高功率器件分散放置
- [ ] 温度敏感元件远离热源
- [ ] 散热器安装空间预留
- [ ] 气流路径无阻碍
- [ ] 热通孔布置合理

### 信号完整性检查
- [ ] 差分对就近平行布置
- [ ] 高速信号远离板边
- [ ] 时钟源居中放置
- [ ] 终端匹配电阻靠近接收端
- [ ] 串扰敏感信号适当隔离

### 可制造性检查
- [ ] 元器件间距满足贴装要求
- [ ] 避免细间距器件聚集
- [ ] 极性标识清晰
- [ ] 丝印不与焊盘重叠
- [ ] 预留返修空间

### 布局评审要点
- [ ] 与原理图设计意图一致
- [ ] 关键路径长度可接受
- [ ] 热仿真结果满足要求
- [ ] EMI风险评估完成
- [ ] 布局密度合理，有扩展空间

### 文档记录
- [ ] 布局约束文档更新
- [ ] 特殊处理说明记录
- [ ] 关键信号列表维护
- [ ] 设计决策理由记录
- [ ] 与其他部门沟通记录
